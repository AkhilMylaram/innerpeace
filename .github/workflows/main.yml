name: Build and Push Images

on:
  workflow_dispatch:

jobs:
  build-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create public directory
      run: mkdir -p innerpeace/public
      
    - name: Login to Docker Hub
      run: echo "${{ secrets.DOCKER_TOKEN }}" | docker login -u akhilmylaram --password-stdin
      
    - name: Build and push images
      run: |
        TAG=$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA:0:7}
        
        # Build and push app
        docker build -t akhilmylaram/innerpeace-app:$TAG ./innerpeace
        docker push akhilmylaram/innerpeace-app:$TAG
        
        # Build and push nginx
        docker build -t akhilmylaram/innerpeace-nginx:$TAG ./innerpeace/docker/nginx
        docker push akhilmylaram/innerpeace-nginx:$TAG
        
        # Build and push healthcheck
        docker build -t akhilmylaram/innerpeace-healthcheck:$TAG ./innerpeace/docker/healthcheck
        docker push akhilmylaram/innerpeace-healthcheck:$TAG
        
        echo "Images pushed with tag: $TAG"
